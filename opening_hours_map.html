<html xml:lang="de"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:cal="http://www.w3.org/2002/12/cal/ical#"
	xmlns:cc="http://creativecommons.org/ns#"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:xsd="http://www.w3.org/2001/XMLSchema"
>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Auswertung des Tags opening_hours auf einer Karte von OpenStreetMap</title>
<meta name="description" content="Auswertung des Tags opening_hours auf einer Karte von OpenStreetMap" />
<link rel="stylesheet" href="opening_hours.js/css/table.css"/>
<script type="text/javascript">
/*<![CDATA[*/
var map;

if (!document.onLoadFunctions) {
	document.onLoadFunctions = new Array();
	window.onload = function () { for (var i=0; document.onLoadFunctions.length>i;i++) document.onLoadFunctions[i](); }
}

var poi_layer;

var permalinkParams={};
var permalinkObject;

function evaluateOH(data) {
	if (data.opening_hours && typeof data._oh_state == 'undefined') {
		data._oh_value = data.opening_hours; // The opening_hours syntax is used for other tags as well.
		var crashed = true;
		try {
			var oh = new opening_hours(data._oh_value, nominatiomTestJSON);
			var it = oh.getIterator(this.reftime);
			crashed = false;
		} catch (err) {
			crashed = err;
			data._oh_object = crashed;
			data._oh_state = 'error';
		}

		if (!crashed) {
			data._oh_object = oh;
			data._it_object = it;
			if (oh.getWarnings().length > 0) {
				data._oh_state = 'warning';
			} else {
				data._oh_state = 'ok';
			}
		}
		return data._oh_state;
	}
}

function Evaluate(number, reset, value) {
	window.open('http://robin.de.marissa.hostorama.ch/osm/opening_hours.js/demo.html' + '?EXP='+encodeURIComponent(value),'_blank');
}


var nominatiomTestJSON = {"place_id":"44651229","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"36248375","lat":"49.5400039","lon":"9.7937133","display_name":"K 2847, Lauda-K\u00f6nigshofen, Main-Tauber-Kreis, Regierungsbezirk Stuttgart, Baden-W\u00fcrttemberg, Germany, European Union","address":{"road":"K 2847","city":"Lauda-K\u00f6nigshofen","county":"Main-Tauber-Kreis","state_district":"Regierungsbezirk Stuttgart","state":"Baden-W\u00fcrttemberg","country":"Germany","country_code":"de","continent":"European Union"}};

document.onLoadFunctions.push ( function () {

	//----------------------------------------------------------------------------
	//	Karte - der Name ('map') muss mit der id des <div> uebereinstimmen.
	//----------------------------------------------------------------------------

	map = new OpenLayers.Map ('map', {controls:[]});

	//----------------------------------------------------------------------------
	//	Default-Koordinatensystem fuer alle Controls
	//----------------------------------------------------------------------------

	map.displayProjection = new OpenLayers.Projection ('EPSG:4326');

	//----------------------------------------------------------------------------
	//	Patch
	//----------------------------------------------------------------------------

	OpenLayers.Control.Permalink.prototype.updateLink = function() {

		permalinkObject = this;
		var href=this.base;
		if(href.indexOf('?')!=-1){
			href=href.substring(0,href.indexOf('?'));
		}
		href+='?'+OpenLayers.Util.getParameterString(OpenLayers.Util.extend(this.createParams(), permalinkParams));
		this.element.href=href;
	};

	//----------------------------------------------------------------------------
	//	Steuerelemente
	//----------------------------------------------------------------------------

	map.addControl (new OpenLayers.Control.LayerSwitcher());
	map.addControl (new OpenLayers.Control.LoadStatus(
		{html: '<img src="img/ajax-loader.gif" /><br />${layers}'}
	));
	map.addControl (new OpenLayers.Control.MousePosition());
	map.addControl (new OpenLayers.Control.Navigation());
	map.addControl (new OpenLayers.Control.PanZoomBar());
	map.addControl (new OpenLayers.Control.Permalink());
	map.addControl (new OpenLayers.Control.ZoomStatus(
	{html: 'Die Marker werden erst auf Zoom Stufe ${next} geladen. Aktuelle Zoom Stufe ist ${actual}.'}));

	//----------------------------------------------------------------------------
	//	Kartenlayer
	//----------------------------------------------------------------------------

	map.addLayer (new OpenLayers.Layer.OSM.Mapnik('Mapnik'));
	map.addLayer (new OpenLayers.Layer.OSM.CycleMap('CycleMap'));

	//----------------------------------------------------------------------------
	//**	JSONP-POI-Layer
	//----------------------------------------------------------------------------

	map.addLayer (poi_layer = new OpenLayers.Layer.PopupMarker ('opening_hours', {

		//------------------------------------------------------------
		//	blocksize=0 deaktiviert das Cachen von Markern.
		//------------------------------------------------------------

		blockSize: 0,

		//------------------------------------------------------------
		//	Marker in allen Zoomstufen darstellen
		//------------------------------------------------------------

		minZoom: 0,

		//------------------------------------------------------------
		//	JOSM&Co Links anzeigen
		//------------------------------------------------------------

		osmlinks: true,
		reftime: new Date(),

		createHtmlFromData: function (data) {

			var base_url = 'http://www.netzwolf.info/kartografie/osm/time_domain/';
			var h_icon = '<img src="' + this.getIconUrl(data) + '" alt=""/>';
			var h_name = this.html(data.name||data.ref||data.operator||data.shop||data.amenity||data.id);

			var text = '<h3>'+h_icon+'&#160;'+h_name+'</h3>\n';
			text += '<div class="v">'+this.html(data.opening_hours)+'</div>';

			evaluateOH(data);
			if (data._oh_state == 'error') {
				text += '<div class="e">'+data._oh_object+'</div>';
			} else {

				if (this.DisplayMode == 'QA') {
					var t= data._it_object.getComment() || '';

					switch (data._it_object.getStateString(true)) {
					case 'open':	text+='<b class="o">open @ '+this.reftime.toLocaleString()+'<br/>'+t+'</b>'; break;
					case 'closed':	text+='<b class="c">closed @ '+this.reftime.toLocaleString()+'<br/>'+t+'</b>'; break;
					case 'unknown':	text+='<b class="u">unknown @ '+this.reftime.toLocaleString()+'<br/>'+t+'</b>'; break;
					}

					var prettified = data._oh_object.prettifyValue();

					if (data._oh_value != prettified)
						text += '<br/>' + i18n.t('texts.prettified value') + ': <div class="v">'+prettified+'</div>';

					var warnings = data._oh_object.getWarnings();
					if (warnings.length > 0)
						text += '<br/>Warnings: <div class="v">'+warnings.join('<br/>\n')+'</div>';
				}

				text += OpeningHoursTable.drawTableAndComments(data._oh_object, data._it_object, data._oh_value);

				// if (!data._time.value && data._time.times.length>=1)
				// text+='<div class="o">will open @ '+data._time.times[0].t.toLocaleString()+
				// 	(data._time.times[0].c? ' ('+data._time.times[0].c+')' : '') + '</div>';

				// if (data._time.warnings) text+='<div class="m">'+data._time.warnings.join('<br/>')+'</div>';
			}

			var rows=[];
			for (var tag in data) {
				if (data[tag] == '') continue;
				switch (tag) {
				case 'id': case 'lat': case 'lon': case 'name': case 'created_by':
				case 'opening_hours': case '_oh_value': case '_oh_state': case '_oh_object': case '_it_object':
					continue;
				}
				val=this.html(data[tag]);
				if (val.substr(0,7)=='http://') {
					var res = [];
					var list=data[tag].split (';');
					for (var i=0; i<list.length;i++) {
						var ele=this.html(OpenLayers.String.trim(list[i]));
						res.push ('<a target="_blank" href="' + base_url +ele+'">'+ele+'</a>');
					}
					val=res.join('; ');
				}
				rows.push ('<tr><td>'+this.html(tag)+':</td><td>'+val+'</td></tr>');
			}

			if (rows.length>=1) text += '<table>'+rows.join('\n')+'</table>\n';

			var osmlinks = this.createOsmLinks (data);
			if (osmlinks) text += '<p>'+osmlinks+'</p>\n';

			return text;
		},

		//------------------------------------------------------------
		//	Icons
		//------------------------------------------------------------

		createIconFromData: function (data) {
			return new OpenLayers.Icon(this.getIconUrl(data));
		},

		getIconUrl: function (data) {

			if (data.opening_hours) {
				evaluateOH(data);
				var oh = data._oh_object;
				if (this.DisplayMode == 'normal') {
					switch (data._oh_state) {
					case 'ok':      return 'img/circle_' + (oh.getState() ? 'green' : (oh.getUnknown() ? 'white' : 'red')) + '.png';
					case 'error':   return 'img/circle_yellow.png';
					}
				} else if (this.DisplayMode == 'QA') {
					switch (data._oh_state) {
					case 'ok':      return 'img/circle_green.png';
					case 'warning': return 'img/circle_yellow.png';
					case 'error':   return 'img/circle_red.png';
					}
				}
			}
		},

		//------------------------------------------------------------
		//	Welche POIs laden?
		//------------------------------------------------------------

		keyValues: [
		],

		//------------------------------------------------------------
		//	Nach pan oder zoom: POIs neuladen.
		//------------------------------------------------------------

		moveTo: function (bounds, zoomChanged, dragging) {

			OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments);

			if (dragging || !this.visibility || this.map.zoom<this.minZoom) return;

			this.reloadPOIs();
		},

		//------------------------------------------------------------
		//	POIs neuladen.
		//	Muss nach Ändern von keyValues augerufen werden.
		//------------------------------------------------------------

		reloadPOIs: function () {

			if (this.updateKeyValues) this.updateKeyValues();

			var xml = this.overpassXML (this.keyValues);
			var url = 'http://overpass-api.de/api/interpreter?jsonp=#&data=' + encodeURIComponent(xml);
			this.jsonpRequest (url, this, this.jsonCallback);
		},

		//------------------------------------------------------------
		//	Parse keyvalues from text
		//------------------------------------------------------------

		parseKeyValues: function (text) {

			var keyvals = [];
			var taglist = [];

			//------------------------------------------------------------
			//	Splitte den textarea-Inhalt in Zeilen.
			//------------------------------------------------------------

			var lines = text.split('\n');
			for (var i in lines) {

				//----------------------------------------------------
				//	Splitte die Zeile in tag und value.
				//----------------------------------------------------

				var fields = lines[i].split ('=');

				var key  = OpenLayers.String.trim (fields[0] || '');
				if (!key) continue;

				//----------------------------------------------------
				//	Neues Objekt mit key
				//----------------------------------------------------

				var keyval = { 'key': key };

				//----------------------------------------------------
				//	Wenn value, dann auch value (sonst key=*)
				//----------------------------------------------------

				var value= OpenLayers.String.trim (fields[1] || '');
				if (value) keyval.value = value;

				//----------------------------------------------------
				//	In Liste aufnehmen
				//----------------------------------------------------

				keyvals.push (keyval);
				taglist.push (key + (value ? '=' + value : ''));
			}

			//------------------------------------------------------------
			//	Trage die Keyval-Liste im Layer ein.
			//------------------------------------------------------------

			permalinkParams.tags = taglist.join(',');
			this.keyValues = keyvals;
		},

		//------------------------------------------------------------
		//	Baue aus der keyValues eine overpass-Anfrage.
		//------------------------------------------------------------

		overpassXML: function (keyvalues) {

			if (!(keyvalues instanceof Array)) keyvalues = [keyvalues];

			var bbox = this.map.getExtent().
				transform(this.map.getProjectionObject(),this.map.displayProjection);

			var bboxQuery = OpenLayers.String.format (
				'<bbox-query s="${bottom}" n="${top}" w="${left}" e="${right}"/>',
				bbox);

			var components = [];
			for (var i in keyvalues) {
				var keyvalue = keyvalues[i];
				var key = keyvalue.key;
				if (!key) continue;
				var value = keyvalue.value;
				var kvlist = [];
				kvlist.push ("<has-kv");
				if (key) kvlist.push ('k="' + this.html(key) + '"');
				if (value) kvlist.push ('v="' + this.html(value) + '"');
				kvlist.push ("/>");
				components.push ('<query type="node">' + bboxQuery + kvlist.join(' ') + '</query>');
			}

			var xml = '<osm-script output="json"><union>' + components.join('') + '</union><print/></osm-script>';

			return xml;
		},

		//------------------------------------------------------------
		//	Callback-Funktion für JSONP:
		//	Löscht die bestehenden POIs und trägt die neuen ein.
		//------------------------------------------------------------

		jsonCallback: function (data) {

			var elements = data.elements;
			if (!elements) {
				alert ('Missing "elements" in overpassXML json data.');
				return;
			}
			this.erase (true);
			for (var i in elements) {
				var element = elements[i];
				var data = element.tags;
				if (!data) data = {};
				if (element.id) data.id = (element.type ? element.type.substr(0,1) : '') + element.id;
				if (element.type) data._type = element.type;
				data.lat = element.lat;
				data.lon = element.lon;
				this.createMarker (data);
			}
		},

		//------------------------------------------------------------
		//	Update keyValues
		//------------------------------------------------------------

		updateKeyValues: function () {

			this.parseKeyValues (document.getElementById('tagselector_input').value);
		},

		DisplayMode: 'normal',

		filter: OpenLayers.Util.getParameters().filter=='error' ? function (data) {
				this.DisplayMode = 'QA';
				return evaluateOH(data) == 'error' || data._oh_object.getWarnings() != '';
			} : OpenLayers.Util.getParameters().filter=='open' ? function (data) {
				if (evaluateOH(data) == 'error')
					return false;
				else
					return data._it_object.getState();
			} : OpenLayers.Util.getParameters().filter=='unknown' ? function (data) {
				if (evaluateOH(data) == 'error')
					return false;
				else
					return data._it_object.getUnknown();
			} : OpenLayers.Util.getParameters().filter=='OpenOrUnknown' ? function (data) {
				if (evaluateOH(data) == 'error')
					return false;
				else
					return data._it_object.getUnknown() || data._it_object.getUnknown();
			} : null,

		minZoom: 14,
		blockSize: 0,	// no cache
		clusterSize: 16,
		clusterLimit: 50

	} ));

	//----------------------------------------------------------------------------
	//	Klick auf Button bei "POIs konfigurieren"
	//----------------------------------------------------------------------------

	document.getElementById('tagselector_button').onclick = function () {
		poi_layer.reloadPOIs();
		permalinkObject.updateLink();
	};

	//----------------------------------------------------------------------------
	//	Stelle bestimmten Bereich in maximaler Groesse dar
	//----------------------------------------------------------------------------

	if (!map.getCenter()) {
		map.zoomToExtent(
			new OpenLayers.Bounds(7.1042, 50.7362, 7.1171, 50.7417).
		transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
	}
});
/*]]>*/</script>
<script type="text/javascript" src="js/OpenLayers-2.13.1/OpenLayers.js"></script>
<script type="text/javascript" src="js/OpenStreetMap.js"></script>
<script type="text/javascript" src="js/popupmarker.js"></script>
<script type="text/javascript" src="js/loadstatus.js"></script>
<script type="text/javascript" src="js/zoomstatus.js"></script>
<script type="text/javascript" src="opening_hours.js/opening_hours.js"></script>
<script type="text/javascript" src="opening_hours.js/js/i18next-1.6.3.min.js"></script>
<script type="text/javascript" src="opening_hours.js/js/i18n-resources.js"></script>
<script type="text/javascript" src="opening_hours.js/js/opening_hours_table.js"></script>
<style type="text/css">
.olMap {
	color: black;
}

.olMap a {
	background: transparent;
	color: blue;
	text-decoration: none;
}

.olControlAttribution {
	bottom: 0.1em !important;
	left: 0.1em;
	right: auto !important;
}

.olControlLoadStatus {
	left: 50px;
	top: 10px;
}

.olControlMaplink {
	right: 0.1em;
	font-size: smaller;
}

#ml1 {
	bottom: 4.2em;
}

#ml2 {
	bottom: 3.0em;
}

.olControlMousePosition {
	background: white;
	bottom: 0.1em;
	font-family: Monospace;
	opacity: 0.7;
	right: 0.1em;
}

.olControlZoomstatus {
	bottom: 1.5em;
	left: 0px;
	background: white;
	opacity: 0.7;
}

/* .olFramedCloudPopupContent { */
/* 	max-height: 400px; */
/* } */
/*  */
/* .olFramedCloudPopupContent, */
/* .olFramedCloudPopupContent table { */
/* 	color: black; */
/* } */

.olFramedCloudPopupContent h3 {
	font-size: 120%;
	font-weight: bold;
	margin: 0;
}

.olFramedCloudPopupContent h3 img {
	height: 16px;
	width: 16px;
}

/* .olFramedCloudPopupContent td { */
/* 	background: transparent; */
/* 	margin: 0; */
/* 	padding: 0; */
/* } */
/*  */
/* .olFramedCloudPopupContent p { */
/* 	font-size: xx-small; */
/* 	margin: 0 0 1em; */
/* 	text-align: right; */
/* } */

.olFramedCloudPopupContent hr {
	display: none;
}

.olFramedCloudPopupContent .v {
	color:black;
	background: #dddddd;
	border: 1px solid gray;
	font-family: Monospace;
}

.olFramedCloudPopupContent .e {
	background: red;
	color: white;
	font-weight: bold;
	padding: 2px;
}

.olFramedCloudPopupContent .m {
	background: gray;
	color: white;
	font-weight: bold;
	padding: 2px;
}

.olFramedCloudPopupContent .o {
	color: blue;
}

.olFramedCloudPopupContent .c {
	color: gray;
}

.olFramedCloudPopupContent .u {
	color: red;
}

.olFramedCloudPopupContent .t {
	color: red;
}

#map {
	background: gray;
	height:100%;
	width:100%;
}

@media print {
	.olControlMousePosition,
	.olControlPanZoomBar,
	.olControlPermalink,
	.olControlZoomstatus {
		display: none !important;
	}
}

</style>

</head>

<body>
<div id="map"></div>

<div id="tagselector">
	<b>POIs konfigurieren</b>
	<div>
		<textarea id="tagselector_input" cols="24" rows="5">
		opening_hours
		</textarea><br/>
		<button id="tagselector_button">Karte aktualisieren</button>
	</div>
</div>

<h1>Karte mit Layer für "opening_hours"</h1>

<p>
	Im <a href="http://robin.de.marissa.hostorama.ch/osm/opening_hours_map/opening_hours_map.html">normalen Modus</a> zeigt die Karte Knoten mit dem Tag
	<a rel="external" href="http://wiki.openstreetmap.org/wiki/Key:opening_hours">opening_hours</a>
	als farbige Kreise:

	<ul>
		<li>Grün: <q>jetzt geöffnet</q>,</li>
		<!-- <li>Blaugelb: <q>24/7 geöffnet</q>,</li> -->
		<!-- <li>Graublau: <q>geschlossen, öffnet aber heute noch</q>,</li> -->
		<!-- <li>Grau: <q>geschlossen, öffnet heute nicht mehr</q>,</li> -->
		<li>Weiß: <q>zur Zeit unbekannt</q>,</li>
		<li>Rot: <q>zur Zeit geschlossen,</li>
	</ul>
</p>

<p>
	Falls die Karte im <a href="http://robin.de.marissa.hostorama.ch/osm/opening_hours_map/opening_hours_map.html=filter?error">Qualitätssicherung Modus</a> angezeitg wird, werden nur Fehlerhafte opening_hours und welche mit Warnung angezeit. In diesem Modus werden andere Farben benutzt:

	<ul>
		<li>Grün: Öffnungszeit kann ohne Warnungen ausgewertet,</li>
		<li>Gelb: Öffnungszeit kann ausgewertet allerdings mit Warnungen,</li>
		<li>Rot: Formatfehler oder noch nicht unterstützes Element in den opening_hours,</li>
	</ul>
</p>

<p>
	Die zugrundeliegende stammen von der <a href="http://overpass-api.de/">Overpass API</a>.
</p>

</body>
</html>
