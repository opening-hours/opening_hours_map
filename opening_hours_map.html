<html xml:lang="de"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:cal="http://www.w3.org/2002/12/cal/ical#"
	xmlns:cc="http://creativecommons.org/ns#"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:xsd="http://www.w3.org/2001/XMLSchema"
>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Auswertung des Tags opening_hours auf einer Karte von OpenStreetMap</title>
<meta name="description" content="Auswertung des Tags opening_hours auf einer Karte von OpenStreetMap" />
<script type="text/javascript">
/*<![CDATA[*/
var map;

if (!document.onLoadFunctions) {
	document.onLoadFunctions = new Array();
	window.onload = function () { for (var i=0; document.onLoadFunctions.length>i;i++) document.onLoadFunctions[i](); }
}

var poi_layer;

var permalinkParams={};
var permalinkObject;

document.onLoadFunctions.push ( function () {

	//----------------------------------------------------------------------------
	//	Karte - der Name ('map') muss mit der id des <div> uebereinstimmen.
	//----------------------------------------------------------------------------

	map = new OpenLayers.Map ('map', {controls:[]});

	//----------------------------------------------------------------------------
	//	Default-Koordinatensystem fuer alle Controls
	//----------------------------------------------------------------------------

	map.displayProjection = new OpenLayers.Projection ('EPSG:4326');

	//----------------------------------------------------------------------------
	//	Patch
	//----------------------------------------------------------------------------

	OpenLayers.Control.Permalink.prototype.updateLink = function() {

		permalinkObject = this;
		var href=this.base;
		if(href.indexOf('?')!=-1){
			href=href.substring(0,href.indexOf('?'));
		}
		href+='?'+OpenLayers.Util.getParameterString(OpenLayers.Util.extend(this.createParams(), permalinkParams));
		this.element.href=href;
	};

	//----------------------------------------------------------------------------
	//	Steuerelemente
	//----------------------------------------------------------------------------

	map.addControl (new OpenLayers.Control.LayerSwitcher());
	map.addControl (new OpenLayers.Control.LoadStatus(
		{html: '<img src="img/ajax-loader.gif" /><br />${layers}'}
	));
	map.addControl (new OpenLayers.Control.MousePosition());
	map.addControl (new OpenLayers.Control.Navigation());
	map.addControl (new OpenLayers.Control.PanZoomBar());
	map.addControl (new OpenLayers.Control.Permalink());

	//----------------------------------------------------------------------------
	//	Tooltipschalter
	//----------------------------------------------------------------------------

	map.addControl (new OpenLayers.Control ({

		id: 'tooltipSwitch',

		draw:function(){

			OpenLayers.Control.prototype.draw.apply(this,arguments);
			if(!this.element){

				this.element=document.createElement('button');
				this.element.innerHTML='Namen ein/aus';
				this.element.onclick = function () {
					var body=document.getElementsByTagName('body')[0];
					body.className = body.className ? '' : 'on';
				}
				this.element.control=this;
				this.div.appendChild(this.element);
			}
			return this.div;
		}
	}));

	//----------------------------------------------------------------------------
	//	Kartenlayer
	//----------------------------------------------------------------------------

	map.addLayer (new OpenLayers.Layer.OSM.Mapnik('Mapnik'));
	map.addLayer (new OpenLayers.Layer.OSM.CycleMap('CycleMap'));

	//----------------------------------------------------------------------------
	//**	JSONP-POI-Layer
	//----------------------------------------------------------------------------

	map.addLayer (poi_layer = new OpenLayers.Layer.PopupMarker ('Orte von Interesse', {

		//------------------------------------------------------------
		//	blocksize=0 deaktiviert das Cachen von Markern.
		//------------------------------------------------------------

		blockSize: 0,

		//------------------------------------------------------------
		//	Marker in allen Zoomstufen darstellen
		//------------------------------------------------------------

		minZoom: 0,

		//------------------------------------------------------------
		//	JOSM&Co Links anzeigen
		//------------------------------------------------------------

		osmlinks: true,

		createHtmlFromData: function (data) {

			var base_url = 'http://www.netzwolf.info/kartografie/osm/time_domain/';
			var h_icon = '<img src="' + this.getIconUrl(data) + '" alt=""/>';
			var h_name = this.html(data.name||data.ref||data.operator||data.shop||data.amenity||data.id);

			var text = '<h3>'+h_icon+'&#160;'+h_name+'</h3>\n';
			text += '<div class="v">'+this.html(data.opening_hours)+'</div>';

			// if (data._time.errors) text+='<div class="e">'+data._time.errors.join('<br/>')+'</div>';

			// var t= data._time.comment || '';

			// switch (data._time.value) {
			// case true:	text+='<b class="o">open @ '+this.reftime.toLocaleString()+'<br/>'+t+'</b>'; break;
			// case false:	text+='<b class="c">closed @ '+this.reftime.toLocaleString()+'<br/>'+t+'</b>'; break;
			// case null:	text+='<b class="u">unknown @ '+this.reftime.toLocaleString()+'<br/>'+t+'</b>'; break;
			// }

			// if (!data._time.value && data._time.times.length>=1)
			// text+='<div class="o">will open @ '+data._time.times[0].t.toLocaleString()+
			// 	(data._time.times[0].c? ' ('+data._time.times[0].c+')' : '') + '</div>';

			// if (data._time.warnings) text+='<div class="m">'+data._time.warnings.join('<br/>')+'</div>';

			var rows=[];
			for (var tag in data) {
				if (data[tag] == '') continue;
				switch (tag) {
				case 'id': case 'lat': case 'lon': case 'name': case 'created_by':
				case 'opening_hours': case '_time':
					continue;
				}
				val=this.html(data[tag]);
				if (val.substr(0,7)=='http://') {
					var res = [];
					var list=data[tag].split (';');
					for (var i=0; i<list.length;i++) {
						var ele=this.html(OpenLayers.String.trim(list[i]));
						res.push ('<a target="_blank" href="' + base_url +ele+'">'+ele+'</a>');
					}
					val=res.join('; ');
				}
				rows.push ('<tr><td>'+this.html(tag)+':</td><td>'+val+'</td></tr>');
			}

			if (rows.length>=1) text += '<table>'+rows.join('\n')+'</table>\n';

			var osmlinks = this.createOsmLinks (data);
			if (osmlinks) text += '<p>'+osmlinks+'</p>\n';

			return text;
		},

		//------------------------------------------------------------
		//	Icons
		//------------------------------------------------------------

		createIconFromData: function (data) {
			return new OpenLayers.Icon(this.getIconUrl(data));
		},

		getIconUrl: function (data) {

			if (data.opening_hours) {
				try {
					var oh = new opening_hours(data.opening_hours);
				} catch (err) {
					crashed = err;
					console.log(crashed);
					return 'img/circle_red.png';
				}
				// return '/img/circle_blue_yellow.png';
				return 'img/circle_blue_yellow.png';
			}


			// return '/i/ol/circle_red.png';
		},

		//------------------------------------------------------------
		//	Welche POIs laden?
		//------------------------------------------------------------

		keyValues: [
		],

		//------------------------------------------------------------
		//	Nach pan oder zoom: POIs neuladen.
		//------------------------------------------------------------

		moveTo: function (bounds, zoomChanged, dragging) {

			OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments);

			if (dragging || !this.visibility || this.map.zoom<this.minZoom) return;

			this.reloadPOIs();
		},

		//------------------------------------------------------------
		//	POIs neuladen.
		//	Muss nach Ändern von keyValues augerufen werden.
		//------------------------------------------------------------

		reloadPOIs: function () {

			if (this.updateKeyValues) this.updateKeyValues();

			var xml = this.overpassXML (this.keyValues);
			var url = 'http://overpass-api.de/api/interpreter?jsonp=#&data=' + encodeURIComponent(xml);
			this.jsonpRequest (url, this, this.jsonCallback);
		},

		//------------------------------------------------------------
		//	Parse keyvalues from text
		//------------------------------------------------------------

		parseKeyValues: function (text) {

			var keyvals = [];
			var taglist = [];

			//------------------------------------------------------------
			//	Splitte den textarea-Inhalt in Zeilen.
			//------------------------------------------------------------

			var lines = text.split('\n');
			for (var i in lines) {

				//----------------------------------------------------
				//	Splitte die Zeile in tag und value.
				//----------------------------------------------------

				var fields = lines[i].split ('=');

				var key  = OpenLayers.String.trim (fields[0] || '');
				if (!key) continue;

				//----------------------------------------------------
				//	Neues Objekt mit key
				//----------------------------------------------------

				var keyval = { 'key': key };

				//----------------------------------------------------
				//	Wenn value, dann auch value (sonst key=*)
				//----------------------------------------------------

				var value= OpenLayers.String.trim (fields[1] || '');
				if (value) keyval.value = value;

				//----------------------------------------------------
				//	In Liste aufnehmen
				//----------------------------------------------------

				keyvals.push (keyval);
				taglist.push (key + (value ? '=' + value : ''));
			}

			//------------------------------------------------------------
			//	Trage die Keyval-Liste im Layer ein.
			//------------------------------------------------------------

			permalinkParams.tags = taglist.join(',');
			this.keyValues = keyvals;
		},

		//------------------------------------------------------------
		//	Baue aus der keyValues eine overpass-Anfrage.
		//------------------------------------------------------------

		overpassXML: function (keyvalues) {

			if (!(keyvalues instanceof Array)) keyvalues = [keyvalues];

			var bbox = this.map.getExtent().
				transform(this.map.getProjectionObject(),this.map.displayProjection);

			var bboxQuery = OpenLayers.String.format (
				'<bbox-query s="${bottom}" n="${top}" w="${left}" e="${right}"/>',
				bbox);

			var components = [];
			for (var i in keyvalues) {
				var keyvalue = keyvalues[i];
				var key = keyvalue.key;
				if (!key) continue;
				var value = keyvalue.value;
				var kvlist = [];
				kvlist.push ("<has-kv");
				if (key) kvlist.push ('k="' + this.html(key) + '"');
				if (value) kvlist.push ('v="' + this.html(value) + '"');
				kvlist.push ("/>");
				components.push ('<query type="node">' + bboxQuery + kvlist.join(' ') + '</query>');
			}

			var xml = '<osm-script output="json"><union>' + components.join('') + '</union><print/></osm-script>';

			return xml;
		},

		//------------------------------------------------------------
		//	Callback-Funktion für JSONP:
		//	Löscht die bestehenden POIs und trägt die neuen ein.
		//------------------------------------------------------------

		jsonCallback: function (data) {

			var elements = data.elements;
			if (!elements) {
				alert ('Missing "elements" in overpassXML json data.');
				return;
			}
			this.erase (true);
			for (var i in elements) {
				var element = elements[i];
				var data = element.tags;
				if (!data) data = {};
				if (element.id) data.id = (element.type ? element.type.substr(0,1) : '') + element.id;
				if (element.type) data._type = element.type;
				data.lat = element.lat;
				data.lon = element.lon;
				this.createMarker (data);
			}
		},

		//------------------------------------------------------------
		//	Update keyValues
		//------------------------------------------------------------

		updateKeyValues: function () {

			this.parseKeyValues (document.getElementById('tagselector_input').value);
		},

		//------------------------------------------------------------
		//	Bestimme den Tooltip-Html-Text zu einem Datensatz (optional).
		//------------------------------------------------------------

		createTooltipFromData: function (data) {
			return this.html(data.name || data.ref || '#' + data.id);
		}
	} ));

	//----------------------------------------------------------------------------
	//	Klick auf Button bei "POIs konfigurieren"
	//----------------------------------------------------------------------------

	document.getElementById('tagselector_button').onclick = function () {
		poi_layer.reloadPOIs();
		permalinkObject.updateLink();
	};

	//----------------------------------------------------------------------------
	//	Stelle bestimmten Bereich in maximaler Groesse dar
	//----------------------------------------------------------------------------

	if (!map.getCenter()) {
		map.zoomToExtent(
			new OpenLayers.Bounds(7.1042, 50.7362, 7.1171, 50.7417).
		transform(new OpenLayers.Projection('EPSG:4326'), map.getProjectionObject()));
	}
});
/*]]>*/</script>
<script type="text/javascript" src="js/OpenLayers-2.13.1/OpenLayers.js"></script>
<script type="text/javascript" src="js/OpenStreetMap.js"></script>
<script type="text/javascript" src="js/popupmarker.js"></script>
<script type="text/javascript" src="js/loadstatus.js"></script>
<script type="text/javascript" src="opening_hours.js/opening_hours.js"></script>
<style type="text/css">
.olMap {
	color: black;
}

.olMap a {
	background: transparent;
	color: blue;
	text-decoration: none;
}

.olControlAttribution {
	bottom: 0.1em !important;
	left: 0.1em;
	right: auto !important;
}

.olControlLoadStatus {
	left: 50px;
	top: 10px;
}

.olControlMaplink {
	right: 0.1em;
	font-size: smaller;
}

#ml1 {
	bottom: 4.2em;
}

#ml2 {
	bottom: 3.0em;
}

.olControlMousePosition {
	background: white;
	bottom: 0.1em;
	font-family: Monospace;
	opacity: 0.7;
	right: 0.1em;
}

.olControlZoomstatus {
	bottom: 1.5em;
	left: 0px;
	background: white;
	opacity: 0.7;
}

.olFramedCloudPopupContent {
	max-height: 400px;
}

.olFramedCloudPopupContent,
.olFramedCloudPopupContent table {
	color: black;
}

.olFramedCloudPopupContent h3 {
	font-size: 120%;
	font-weight: bold;
	margin: 0;
}

.olFramedCloudPopupContent h3 img {
	height: 16px;
	width: 16px;
}

.olFramedCloudPopupContent table {
	border: 0;
	margin: 0;
	padding: 0;
}

.olFramedCloudPopupContent td {
	background: transparent;
	margin: 0;
	padding: 0;
}

.olFramedCloudPopupContent p {
	font-size: xx-small;
	margin: 0 0 1em;
	text-align: right;
}

.olFramedCloudPopupContent hr {
	display: none;
}

.olFramedCloudPopupContent .v {
	color:black;
	background: #dddddd;
	border: 1px solid gray;
	font-family: Monospace;
}

.olFramedCloudPopupContent .e {
	background: red;
	color: white;
	font-weight: bold;
	padding: 2px;
}

.olFramedCloudPopupContent .m {
	background: gray;
	color: white;
	font-weight: bold;
	padding: 2px;
}

.olFramedCloudPopupContent .o {
	color: blue;
}

.olFramedCloudPopupContent .c {
	color: gray;
}

.olFramedCloudPopupContent .u {
	color: red;
}

.olFramedCloudPopupContent .t {
	color: red;
}

#map {
	background: gray;
	height:100%;
	width:100%;
}

@media print {
	.olControlMousePosition,
	.olControlPanZoomBar,
	.olControlPermalink,
	.olControlZoomstatus {
		display: none !important;
	}
}

</style>

</head>

<body>
<div id="map"></div>
<div id="tagselector">
<b>POIs konfigurieren</b>
<div>
<textarea id="tagselector_input" cols="24" rows="20">
opening_hours
</textarea><br/>
<button id="tagselector_button">Karte aktualisieren</button>
</div>
</div>
<div id="Xc">
<h1 class="Xs">POIs per JSONP laden</h1>

<div class="Xa">
Springe zu:
<a href="#Xnp" accesskey="S">Seitenhierarchie</a>.
</div>
<p>
Zum Selbermachen:
<a href="overpass_pois2.htm">HTML-Code mit Erklärung</a>.
</p>

<p>
Diese Seite gibt es auch <a href="overpass_pois">ohne konfigurierbarer Tag-Liste</a>.
</p><div id="Xm">
<hr />
©&#160;2010-2013 – zuletzt geändert am 16.08.2010
</div>
</div>

<div id="Xd">
Verbraucherinformation: enthält
<a href="http://validator.w3.org/check?verbose=1&amp;outline=1&amp;uri=http%3A%2F%2Fwww.netzwolf.info%2Fkartografie%2Fopenlayers%2Foverpass_pois2" rel="nofollow">HTML4.0</a>,
<a href="http://jigsaw.w3.org/css-validator/validator?uri=http%3A%2F%2Fwww.netzwolf.info%2Fkartografie%2Fopenlayers%2Foverpass_pois2&amp;warning=no" rel="nofollow">CSS</a>
und eine <a href="/_meta/anbieterkennzeichnung"
	lang="de"
	rel="nofollow">Anbieterkennzeichnung</a>.
<br />
</div>

<div class="Xn">

<hr />
<h2>Navigation</h2>

<div id="Xntpls">
<div id="Xnpls">

<div id="Xnp"><h3>Seitenhierarchie</h3>
<ul>
<li class="X1"><a href="/"
	rel="start">Netzwolf</a></li>
<li><a href="/kartografie/">Kartografie</a></li>
<li><a href="/kartografie/openlayers/">OpenLayers</a></li>
<li><span class="Xs">POIs per JSONP</span></li>
</ul>
</div>

<div id="Xnls">
</div>
</div>
</div>
</div>
</body>
</html>
